---
applyTo: **
---

# NixOS Flake Configuration - AI Coding Guidelines

## Architecture Overview

This is a **flake-based NixOS configuration** managing multiple hosts with a modular structure:

- **Hosts**: `nixluon` (Framework AMD), `nixboerse` (ThinkPad P1 Gen 4)
- **Flake structure**: Uses `flake-parts` for organization, imports hardware profiles from `nixos-hardware`
- **Module system**: Reusable components in `modules/` covering desktop, hardware, editors, system, users
- **Home Manager**: Integrated for user-level configuration in `home/`
- **Custom packages**: Overlay system in `packages/` (e.g., `linux-entra-sso`)

## Style

Use comments only very sparingly. Always prefer clear variable names and split into smaller helper functions and Nix expressions over comments. The only place for comments is in code that is too dense and cannot be refactored further towards clarity.

## Key Development Workflows

### Building & Testing
```bash
# Build system configuration (with nice/ionice for background builds)
nice -n 19 ionice -c 3 nix build .#nixosConfigurations.$(hostname).config.system.build.toplevel

# Apply configuration
sudo nixos-rebuild switch --flake .

# Build VM for testing
nixos-rebuild build-vm --flake . && result/bin/run-$(hostname)-vm &
```

### VM Development
- **SSH into VM**: `ssh -p 2222 viluon@localhost` (port forwarding configured via `virtualisation.forwardPorts`)
- **VM-specific overrides**: Use `virtualisation.vmVariant` to modify VM behavior without affecting host
- **Clean VM state**: `rm $(hostname).qcow2` to reset VM disk

### Installation (Disko-based)
```bash
# Partition and format
sudo -E `which nix` --extra-experimental-features 'nix-command flakes' run -vL github:nix-community/disko/latest -- --flake .#nixluon --mode destroy,format,mount

# Install
sudo -E `which nix` --extra-experimental-features 'nix-command flakes' run -vL github:nix-community/disko/latest#disko-install -- --flake .#nixluon --disk main <path/to/disk>
```

## NixOS-Specific Patterns

### Host Configuration Structure
Each host in `hosts/*/` follows this pattern:
- `default.nix`: Main configuration importing modules and hardware
- `hardware.nix`: Hardware-specific settings (auto-generated by nixos-generate-config)
- `kernel.nix`: Custom kernel patches (e.g., cgroups v1 for JVM compatibility)
- `nvidia.nix`: GPU-specific configuration with hardware acceleration settings

### Module Organization
- **System modules**: `modules/system/` (networking, nix config, monitoring)
- **Hardware modules**: `modules/hardware/` (audio, graphics)
- **Desktop modules**: `modules/desktop/` (GNOME, input methods)
- **User modules**: `modules/users/common.nix` defines the `viluon` user with SSH keys from GitHub API

### VM Customization Pattern
```nix
virtualisation.vmVariant = {
  virtualisation = {
    cores = 2;
    memorySize = 4096;
    forwardPorts = [{ from = "host"; host.port = 2222; guest.port = 22; }];
    qemu = {
      options = ["-enable-kvm" "-display gtk,grab-on-hover=on"];
      package = pkgs.qemu_kvm;
    };
  };
  # VM-only service overrides
  services.qemuGuest.enable = true;
  boot.kernelModules = ["virtio_pci" "virtio_net" /* ... */];
};
```

### Flake Input Management
- **Stable base**: `nixpkgs` on release-25.05, `nixpkgs-unstable` for bleeding edge
- **Input follows**: Most inputs follow main nixpkgs to reduce closures
- **Hardware support**: `nixos-hardware` provides laptop-specific optimizations
- **Development tools**: `nix-index-database`, `nix4vscode` for IDE integration

## Critical Integration Points

### SSH Configuration
- SSH is enabled globally via `modules/system/networking`
- Uses passwordless authentication with GitHub SSH keys (fetched deterministically)
- VM port forwarding automatically configured for development

### Virtualization Setup
- **libvirtd**: Configured with custom network hooks for domain-specific DNS routing
- **Docker integration**: Firewall rules handle routing between minikube subnets and libvirt networks
- **VM variants**: Complete system rebuild as VM for testing configurations

### Custom Package Integration
- Browser extensions (Firefox/Chrome) automatically installed with policies
- Custom packages like `linux-entra-sso` with native messaging hosts
- Overlays applied consistently across all configurations

### Hardware-Specific Considerations
- **NVIDIA**: Prime offload, open drivers, hardware acceleration for media
- **Intel graphics**: Additional drivers for hardware acceleration
- **Framework laptop**: AMD-specific optimizations via nixos-hardware

## Common Pitfalls & Solutions

- **VM networking**: Don't override default networking - use `forwardPorts` instead of manual QEMU netdev
- **Package availability**: Check if packages exist in current nixpkgs version before using
- **Kernel patches**: Use `extraStructuredConfig` with `lib.kernel.yes` syntax for kernel options
- **Service ordering**: libvirtd hooks need `restartTriggers` for proper reloading
